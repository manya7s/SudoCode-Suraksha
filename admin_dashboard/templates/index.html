<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PhishSafe Analytics Dashboard</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root {
      --primary: #4361ee;
      --primary-light: #4895ef;
      --primary-dark: #3a0ca3;
      --secondary: #f72585;
      --success: #4cc9f0;
      --warning: #f8961e;
      --danger: #ef233c;
      --dark: #1a1a2e;
      --light: #f8f9fa;
      --gray: #6c757d;
      --glass: rgba(255, 255, 255, 0.15);
      --card-bg: rgba(255, 255, 255, 0.85);
      --sidebar-width: 200px;
      --sidebar-collapsed-width: 60px;
      --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      --glass-blur: blur(10px);
    }

    .dark-mode {
      --primary: #4895ef;
      --primary-light: #4cc9f0;
      --primary-dark: #4361ee;
      --dark: #f8f9fa;
      --light: #1a1a2e;
      --gray: #adb5bd;
      --glass: rgba(26, 26, 46, 0.7);
      --card-bg: rgba(26, 26, 46, 0.85);
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }

    .glass-effect {
      --glass: rgba(255, 255, 255, 0.2);
      --card-bg: rgba(255, 255, 255, 0.7);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      border: 1px solid rgba(255, 255, 255, 0.18);
    }

    .dark-mode.glass-effect {
      --glass: rgba(26, 26, 46, 0.5);
      --card-bg: rgba(26, 26, 46, 0.6);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--light);
      color: var(--dark);
      transition: var(--transition);
      min-height: 100vh;
      display: flex;
    }

    /* Sidebar */
    .sidebar {
      width: var(--sidebar-width);
      background: var(--glass);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
      padding: 20px 0;
      position: fixed;
      height: 100vh;
      z-index: 100;
      transition: var(--transition);
      overflow-y: auto;
    }

    .sidebar.collapsed {
      width: var(--sidebar-collapsed-width);
    }

    .sidebar.collapsed .sidebar-header h2,
    .sidebar.collapsed .menu-item span:not(.material-icons) {
      display: none;
    }

    .sidebar.collapsed .menu-item {
      justify-content: center;
      padding: 12px 0;
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      padding: 0 20px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      position: relative;
    }

    .sidebar-header h2 {
      margin-left: 10px;
      font-weight: 600;
      color: var(--primary);
      transition: var(--transition);
    }

    .sidebar-toggle {
      position: absolute;
      right: 10px;
      top: 20px;
      cursor: pointer;
      background: none;
      border: none;
      color: var(--dark);
      font-size: 20px;
    }

    .sidebar-menu {
      padding: 20px 0;
    }

    .menu-item {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      margin: 5px 0;
      cursor: pointer;
      transition: var(--transition);
      border-left: 3px solid transparent;
    }

    .menu-item:hover, .menu-item.active {
      background: rgba(67, 97, 238, 0.1);
      border-left: 3px solid var(--primary);
    }

    .menu-item .material-icons {
      margin-right: 10px;
      font-size: 20px;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: var(--sidebar-width);
      padding: 20px;
      transition: var(--transition);
    }

    .sidebar.collapsed ~ .main-content {
      margin-left: var(--sidebar-collapsed-width);
    }

    /* Tab Content */
    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease-in-out;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Top Bar */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
    }

    .search-bar {
      display: flex;
      align-items: center;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 8px 12px;
      width: 300px;
    }

    .search-bar input {
      border: none;
      background: transparent;
      margin-left: 8px;
      width: 100%;
      outline: none;
      color: var(--dark);
    }

    .user-actions {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .theme-toggle, .glass-toggle {
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      transition: var(--transition);
    }

    .theme-toggle:hover, .glass-toggle:hover {
      background: rgba(67, 97, 238, 0.1);
    }

    .notification-badge {
      position: relative;
      cursor: pointer;
    }

    .badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--danger);
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
    }

    .user-profile {
      display: flex;
      align-items: center;
      cursor: pointer;
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      margin-right: 10px;
      font-weight: 600;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      box-shadow: var(--shadow);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      transition: var(--transition);
      cursor: pointer;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    .stat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .stat-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
      margin: 5px 0;
    }

    .stat-title {
      color: var(--gray);
      font-size: 14px;
    }

    .trend {
      display: flex;
      align-items: center;
      font-size: 12px;
      margin-top: 5px;
    }

    .trend.up {
      color: var(--success);
    }

    .trend.down {
      color: var(--danger);
    }

    /* Dashboard Content */
    .dashboard-content {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .chart-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      box-shadow: var(--shadow);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .card-title {
      font-weight: 600;
      font-size: 18px;
    }

    .card-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .chart-container {
      height: 300px;
      position: relative;
    }

    /* Session Logs */
    .session-logs {
      margin-top: 30px;
    }

    .logs-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .filters {
      display: flex;
      gap: 10px;
    }

    .filter-btn {
      background: rgba(67, 97, 238, 0.1);
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      display: flex;
      align-items: center;
      cursor: pointer;
      transition: var(--transition);
      color: var(--dark);
      font-size: 14px;
    }

    .filter-btn:hover {
      background: rgba(67, 97, 238, 0.2);
    }

    .filter-btn.active {
      background: var(--primary);
      color: white;
    }

    .filter-btn .material-icons {
      font-size: 16px;
      margin-right: 5px;
    }

    /* Advanced Filters */
    .advanced-filters {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      display: none;
    }

    .advanced-filters.active {
      display: block;
      animation: fadeIn 0.3s ease-in-out;
    }

    .filter-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .filter-group {
      flex: 1;
      min-width: 200px;
    }

    .filter-label {
      display: block;
      margin-bottom: 5px;
      font-size: 14px;
      color: var(--gray);
    }

    .filter-input, .filter-select {
      width: 100%;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid rgba(67, 97, 238, 0.2);
      background: rgba(255, 255, 255, 0.2);
      color: var(--dark);
      font-family: 'Inter', sans-serif;
      transition: var(--transition);
    }

    .filter-input:focus, .filter-select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2);
    }

    .filter-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 10px;
    }

    /* Session Card */
    .session-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      transition: var(--transition);
      border-left: 4px solid transparent;
      cursor: pointer;
      opacity: 0;
      transform: translateY(20px);
      animation: cardEnter 0.4s ease-out forwards;
    }

    @keyframes cardEnter {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .session-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    .session-card.safe {
      border-left-color: var(--success);
    }

    .session-card.suspicious {
      border-left-color: var(--warning);
    }

    .session-card.threat {
      border-left-color: var(--danger);
    }

    .session-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .session-title {
      font-weight: 600;
      display: flex;
      align-items: center;
    }

    .session-status {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 10px;
      white-space: nowrap;
    }

    .session-status.safe {
      background: rgba(76, 201, 240, 0.2);
      color: var(--success);
    }

    .session-status.suspicious {
      background: rgba(248, 150, 30, 0.2);
      color: var(--warning);
    }

    .session-status.threat {
      background: rgba(239, 35, 60, 0.2);
      color: var(--danger);
    }

    .session-meta {
      display: flex;
      align-items: center;
      color: var(--gray);
      font-size: 14px;
    }

    .session-meta .material-icons {
      font-size: 16px;
      margin-right: 5px;
    }

    .session-body {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .session-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-bottom: 15px;
    }

    .session-stat {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 12px;
      text-align: center;
    }

    .session-stat-value {
      font-weight: 700;
      margin-bottom: 5px;
    }

    .session-stat-label {
      font-size: 12px;
      color: var(--gray);
    }

    /* Activity Path */
    .activity-path {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 15px;
    }

    .path-item {
      display: inline-block;
      margin-right: 5px;
    }

    .path-item:not(:last-child)::after {
      content: '→';
      margin-left: 5px;
      color: var(--gray);
    }

    /* Trust Score Gauge */
    .trust-gauge {
      width: 120px;
      height: 120px;
      position: relative;
      margin: 0 auto 15px;
    }

    .gauge-bg {
      fill: none;
      stroke: #eee;
      stroke-width: 10;
    }

    .gauge-fill {
      fill: none;
      stroke: var(--primary);
      stroke-width: 10;
      stroke-linecap: round;
      transform: rotate(-90deg);
      transform-origin: 50% 50%;
      transition: stroke-dashoffset 1s ease-in-out;
    }

    .gauge-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-weight: 700;
      font-size: 24px;
    }

    .gauge-label {
      text-align: center;
      font-size: 14px;
      color: var(--gray);
    }

    /* High trust score animation */
    .trust-gauge.high-trust .gauge-fill {
      animation: pulseGauge 2s infinite;
    }

    @keyframes pulseGauge {
      0% { stroke: var(--primary); }
      50% { stroke: var(--success); }
      100% { stroke: var(--primary); }
    }

    /* Timeline */
    .timeline {
      position: relative;
      padding-left: 20px;
      margin: 20px 0;
    }

    .timeline::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--primary);
    }

    .timeline-item {
      position: relative;
      padding-bottom: 20px;
      padding-left: 20px;
    }

    .timeline-item::before {
      content: '';
      position: absolute;
      left: -9px;
      top: 0;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--primary);
    }

    .timeline-time {
      font-size: 12px;
      color: var(--gray);
      margin-bottom: 5px;
    }

    .timeline-content {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 10px;
    }

    .timeline-screen {
      font-weight: 600;
      margin-bottom: 5px;
    }

    .timeline-events {
      display: flex;
      gap: 5px;
      font-size: 12px;
    }

    .timeline-event {
      background: rgba(67, 97, 238, 0.1);
      padding: 2px 6px;
      border-radius: 4px;
    }

    /* Heatmap */
    .heatmap {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 5px;
      margin-top: 15px;
    }

    .heatmap-cell {
      height: 30px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: white;
      font-weight: 600;
      position: relative;
      overflow: hidden;
    }

    .heatmap-trend {
      position: absolute;
      bottom: 2px;
      right: 2px;
      font-size: 10px;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      animation: fadeIn 0.3s ease-in-out;
    }

    .modal-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      max-width: 900px;
      max-height: 80vh;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 20px;
      display: flex;
      flex-direction: column;
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .modal-title {
      font-weight: 600;
      font-size: 20px;
    }

    .modal-close {
      cursor: pointer;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }

    .modal-close:hover {
      background: rgba(67, 97, 238, 0.1);
    }

    .modal-body {
      flex: 1;
      overflow-y: auto;
      padding-right: 10px;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .btn {
      padding: 8px 16px;
      border-radius: 8px;
      border: none;
      font-family: 'Inter', sans-serif;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
    }

    .btn-outline:hover {
      background: rgba(67, 97, 238, 0.1);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: #d90429;
    }

    /* JSON Viewer */
    .json-viewer {
      font-family: 'Courier New', Courier, monospace;
      font-size: 14px;
      background: rgba(0, 0, 0, 0.05);
      border-radius: 8px;
      padding: 15px;
      max-height: 60vh;
      overflow-y: auto;
    }

    /* Analytics Page */
    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .analytics-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      box-shadow: var(--shadow);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
    }

    .analytics-card.wide {
      grid-column: span 2;
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .dashboard-content, .analytics-grid {
        grid-template-columns: 1fr;
      }
      .analytics-card.wide {
        grid-column: span 1;
      }
    }

    @media (max-width: 992px) {
      .sidebar {
        transform: translateX(-100%);
        z-index: 1000;
      }
      .sidebar.active {
        transform: translateX(0);
      }
      .main-content {
        margin-left: 0;
      }
      .menu-toggle {
        display: block;
      }
    }

    @media (max-width: 768px) {
      .session-body {
        grid-template-columns: 1fr;
      }
      .session-stats {
        grid-template-columns: repeat(2, 1fr);
      }
      .search-bar {
        width: 200px;
      }
      .modal-content {
        width: 95%;
      }
      .top-bar {
        flex-direction: column;
        gap: 10px;
      }
      .user-actions {
        width: 100%;
        justify-content: space-between;
      }
    }

    @media (max-width: 576px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
      .search-bar {
        width: 100%;
      }
      .filters {
        flex-wrap: wrap;
      }
      .filter-row {
        flex-direction: column;
        gap: 10px;
      }
      .filter-group {
        min-width: 100%;
      }
    }

    /* Bottom Navbar for Mobile */
    .bottom-navbar {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: var(--card-bg);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      z-index: 100;
      padding: 10px 0;
    }

    .bottom-navbar .nav-items {
      display: flex;
      justify-content: space-around;
    }

    .bottom-navbar .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-decoration: none;
      color: var(--gray);
      font-size: 12px;
      transition: var(--transition);
    }

    .bottom-navbar .nav-item.active {
      color: var(--primary);
    }

    .bottom-navbar .nav-item .material-icons {
      font-size: 24px;
      margin-bottom: 2px;
    }

    @media (max-width: 768px) {
      .bottom-navbar {
        display: block;
      }
      .main-content {
        padding-bottom: 70px;
      }
    }

    /* Animations */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    /* Toggle Switch */
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
      margin-left: 10px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: var(--primary);
    }

    input:checked + .slider:before {
      transform: translateX(26px);
    }

    /* Tooltip */
    .tooltip {
      position: relative;
      display: inline-block;
    }

    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background-color: var(--dark);
      color: var(--light);
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 12px;
    }

    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }

    /* Status icons */
    .status-icon {
      margin-right: 5px;
      font-size: 14px;
    }

    /* Table styles */
    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    th {
      background: rgba(67, 97, 238, 0.1);
      font-weight: 600;
    }

    tr:hover {
      background: rgba(67, 97, 238, 0.05);
    }

    .session-checkbox {
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <span class="material-icons" style="color: var(--primary); font-size: 28px;">security</span>
      <h2>PhishSafe</h2>
      <button class="sidebar-toggle" id="sidebarToggle">⋮</button>
    </div>
    <div class="sidebar-menu">
      <div class="menu-item active" data-tab="dashboard">
        <span class="material-icons">dashboard</span>
        Dashboard
      </div>
      <div class="menu-item" data-tab="analytics">
        <span class="material-icons">analytics</span>
        Analytics
      </div>
      <div class="menu-item" data-tab="sessions">
        <span class="material-icons">list_alt</span>
        Sessions
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Top Bar -->
    <div class="top-bar">
      <div class="search-bar">
        <span class="material-icons">search</span>
        <input type="text" placeholder="Search sessions..." id="searchInput">
      </div>
      <div class="user-actions">
        <div class="theme-toggle" id="themeToggle" title="Toggle Dark Mode">
          <span class="material-icons">brightness_4</span>
        </div>
        <div class="glass-toggle" id="glassToggle" title="Toggle Glass Effect">
          <span class="material-icons">blur_on</span>
        </div>
        <div class="user-profile">
          <div class="user-avatar">AD</div>
          <span>Admin</span>
        </div>
      </div>
    </div>

    <!-- Dashboard Tab -->
    <div class="tab-content active" id="dashboard-tab">
      <!-- Stats Grid -->
      <div class="stats-grid" id="statsGrid">
        <!-- Stats will be populated by JavaScript -->
      </div>

      <!-- Dashboard Content -->
      <div class="dashboard-content">
        <div class="chart-card">
          <div class="card-header">
            <div class="card-title">Session Activity</div>
            <div class="card-actions">
              <button class="filter-btn" id="timeFilter">
                <span class="material-icons">calendar_today</span>
                Last 7 days
              </button>
            </div>
          </div>
          <div class="chart-container">
            <div id="sessionChart"></div>
          </div>
        </div>
        <div class="chart-card">
          <div class="card-header">
            <div class="card-title">Threat Classification</div>
            <div class="card-actions">
              <button class="filter-btn active" id="refreshBtn">
                <span class="material-icons">refresh</span>
                Live
              </button>
            </div>
          </div>
          <div class="chart-container">
            <div id="threatChart"></div>
          </div>
        </div>
      </div>

      <!-- Session Logs -->
      <div class="session-logs">
        <div class="logs-header">
          <h3>Recent Sessions</h3>
          <div class="filters">
            <button class="filter-btn" id="filterBtn">
              <span class="material-icons">filter_list</span>
              Filters
            </button>
            <button class="filter-btn" id="exportBtn">
              <span class="material-icons">download</span>
              Export
            </button>
            <div class="tooltip">
              <button class="filter-btn active" id="autoRefreshBtn">
                <span class="material-icons">autorenew</span>
                Auto-refresh
                <span id="lastUpdatedTime"></span>
              </button>
              <span class="tooltiptext">Automatically refresh session data every 30 seconds</span>
            </div>
          </div>
        </div>

        <!-- Advanced Filters -->
        <div class="advanced-filters" id="advancedFilters">
          <div class="filter-row">
            <div class="filter-group">
              <label class="filter-label">Date Range</label>
              <div style="display: flex; gap: 10px;">
                <input type="date" class="filter-input" id="dateFrom">
                <input type="date" class="filter-input" id="dateTo">
              </div>
            </div>
            <div class="filter-group">
              <label class="filter-label">Trust Score</label>
              <div style="display: flex; gap: 10px; align-items: center;">
                <input type="range" class="filter-input" id="trustScoreRange" min="0" max="100" value="70">
                <span id="trustScoreValue">70+</span>
              </div>
            </div>
          </div>
          <div class="filter-row">
            <div class="filter-group">
              <label class="filter-label">Device Manufacturer</label>
              <select class="filter-select" id="deviceManufacturer">
                <option value="">All Manufacturers</option>
                <option value="samsung">Samsung</option>
                <option value="google">Google</option>
                <option value="oneplus">OnePlus</option>
                <option value="xiaomi">Xiaomi</option>
              </select>
            </div>
            <div class="filter-group">
              <label class="filter-label">Screen Recording</label>
              <select class="filter-select" id="screenRecording">
                <option value="">All Sessions</option>
                <option value="true">Detected</option>
                <option value="false">Not Detected</option>
              </select>
            </div>
          </div>
          <div class="filter-actions">
            <button class="btn btn-outline" id="resetFilters">
              <span class="material-icons">clear</span>
              Reset
            </button>
            <button class="btn btn-primary" id="applyFilters">
              <span class="material-icons">check</span>
              Apply Filters
            </button>
          </div>
        </div>

        <!-- Session Cards Container -->
        <div id="sessionCardsContainer">
          <!-- Session cards will be populated by JavaScript -->
        </div>
      </div>
    </div>

    <!-- Analytics Tab -->
    <div class="tab-content" id="analytics-tab">
      <div class="analytics-grid">
        <div class="analytics-card wide">
          <div class="card-header">
            <div class="card-title">Sessions per Device Manufacturer</div>
            <div class="card-actions">
              <button class="filter-btn" id="manufacturerTimeFilter">
                <span class="material-icons">calendar_today</span>
                Last 30 days
              </button>
            </div>
          </div>
          <div class="chart-container">
            <div id="manufacturerChart"></div>
          </div>
        </div>
        <div class="analytics-card">
          <div class="card-header">
            <div class="card-title">Trust Score Distribution</div>
          </div>
          <div class="chart-container">
            <div id="trustScoreChart"></div>
          </div>
        </div>
        <div class="analytics-card">
          <div class="card-header">
            <div class="card-title">Screen Recording Detection</div>
          </div>
          <div class="chart-container">
            <div id="recordingChart"></div>
          </div>
        </div>
        <div class="analytics-card wide">
          <div class="card-header">
            <div class="card-title">Trust Score Over Time</div>
            <div class="card-actions">
              <button class="filter-btn" id="trustScoreTimeFilter">
                <span class="material-icons">calendar_today</span>
                Last 14 days
              </button>
            </div>
          </div>
          <div class="chart-container">
            <div id="trustScoreOverTimeChart"></div>
          </div>
        </div>
        <div class="analytics-card">
          <div class="card-header">
            <div class="card-title">Average Session Duration</div>
          </div>
          <div class="chart-container">
            <div id="durationChart"></div>
          </div>
        </div>
        <div class="analytics-card">
          <div class="card-header">
            <div class="card-title">Screens per Session</div>
          </div>
          <div class="chart-container">
            <div id="screensChart"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sessions Tab -->
    <div class="tab-content" id="sessions-tab">
      <div class="session-logs">
        <div class="logs-header">
          <h3>All Sessions</h3>
          <div class="filters">
            <button class="filter-btn" id="sessionsFilterBtn">
              <span class="material-icons">filter_list</span>
              Filters
            </button>
            <button class="filter-btn" id="sessionsExportBtn">
              <span class="material-icons">download</span>
              Export
            </button>
            <button class="filter-btn" id="deleteSelectedBtn" style="display: none;">
              <span class="material-icons">delete</span>
              Delete Selected
            </button>
          </div>
        </div>

        <!-- Advanced Filters -->
        <div class="advanced-filters" id="sessionsAdvancedFilters">
          <div class="filter-row">
            <div class="filter-group">
              <label class="filter-label">Date Range</label>
              <div style="display: flex; gap: 10px;">
                <input type="date" class="filter-input" id="sessionsDateFrom">
                <input type="date" class="filter-input" id="sessionsDateTo">
              </div>
            </div>
            <div class="filter-group">
              <label class="filter-label">Trust Score</label>
              <div style="display: flex; gap: 10px; align-items: center;">
                <input type="range" class="filter-input" id="sessionsTrustScoreRange" min="0" max="100" value="70">
                <span id="sessionsTrustScoreValue">70+</span>
              </div>
            </div>
          </div>
          <div class="filter-row">
            <div class="filter-group">
              <label class="filter-label">Status</label>
              <select class="filter-select" id="sessionsStatus">
                <option value="">All Statuses</option>
                <option value="safe">Safe</option>
                <option value="suspicious">Suspicious</option>
                <option value="threat">Threat</option>
              </select>
            </div>
            <div class="filter-group">
              <label class="filter-label">Device Manufacturer</label>
              <select class="filter-select" id="sessionsDeviceManufacturer">
                <option value="">All Manufacturers</option>
                <option value="samsung">Samsung</option>
                <option value="google">Google</option>
                <option value="oneplus">OnePlus</option>
                <option value="xiaomi">Xiaomi</option>
              </select>
            </div>
          </div>
          <div class="filter-actions">
            <button class="btn btn-outline" id="sessionsResetFilters">
              <span class="material-icons">clear</span>
              Reset
            </button>
            <button class="btn btn-primary" id="sessionsApplyFilters">
              <span class="material-icons">check</span>
              Apply Filters
            </button>
          </div>
        </div>

        <!-- Sessions Table -->
        <div class="chart-card">
          <div class="card-header">
            <div class="card-title">Session List</div>
            <div class="card-actions">
              <div class="tooltip">
                <button class="filter-btn" id="selectAllBtn">
                  <span class="material-icons">select_all</span>
                  Select All
                </button>
                <span class="tooltiptext">Select all filtered sessions</span>
              </div>
            </div>
          </div>
          <div style="overflow-x: auto;">
            <table>
              <thead>
                <tr>
                  <th style="width: 40px;"></th>
                  <th>Session ID</th>
                  <th>Date</th>
                  <th>Device</th>
                  <th>Trust Score</th>
                  <th style="min-width: 100px;">Status</th>
                  <th>Duration</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="sessionsTableBody">
                <!-- Sessions will be populated by JavaScript -->
              </tbody>
            </table>
          </div>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
            <div style="font-size: 14px; color: var(--gray);">
              Showing <span id="showingCount">0</span> of <span id="totalCount">0</span> sessions
            </div>
            <div style="display: flex; gap: 10px;">
              <button class="btn btn-outline" id="prevPageBtn" disabled>
                <span class="material-icons">chevron_left</span>
                Previous
              </button>
              <button class="btn btn-outline" id="nextPageBtn" disabled>
                Next
                <span class="material-icons">chevron_right</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Navbar for Mobile -->
  <div class="bottom-navbar">
    <div class="nav-items">
      <a href="#" class="nav-item active" data-tab="dashboard">
        <span class="material-icons">dashboard</span>
        Dashboard
      </a>
      <a href="#" class="nav-item" data-tab="analytics">
        <span class="material-icons">analytics</span>
        Analytics
      </a>
      <a href="#" class="nav-item" data-tab="sessions">
        <span class="material-icons">list_alt</span>
        Sessions
      </a>
    </div>
  </div>

  <!-- Session Details Modal -->
  <div class="modal" id="sessionModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Session Details</div>
        <div class="modal-close" id="modalClose">
          <span class="material-icons">close</span>
        </div>
      </div>
      <div class="modal-body">
        <div class="json-viewer" id="sessionJsonViewer"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="copyJsonBtn">
          <span class="material-icons">content_copy</span>
          Copy JSON
        </button>
        <button class="btn btn-primary" id="closeModalBtn">
          Close
        </button>
      </div>
    </div>
  </div>

  <script>
    // Theme Toggle
    const themeToggle = document.getElementById('themeToggle');
    const glassToggle = document.getElementById('glassToggle');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const body = document.body;
    const sidebar = document.querySelector('.sidebar');
    
    // Check for saved theme preference
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
      body.classList.add('dark-mode');
      themeToggle.innerHTML = '<span class="material-icons">brightness_7</span>';
    }
    
    // Check for glass effect preference
    const savedGlassEffect = localStorage.getItem('glassEffect');
    if (savedGlassEffect === 'true') {
      body.classList.add('glass-effect');
      glassToggle.innerHTML = '<span class="material-icons">blur_off</span>';
    }
    
    // Check for sidebar collapsed state
    const savedSidebarState = localStorage.getItem('sidebarCollapsed');
    if (savedSidebarState === 'true') {
      sidebar.classList.add('collapsed');
    }
    
    themeToggle.addEventListener('click', () => {
      body.classList.toggle('dark-mode');
      const isDark = body.classList.contains('dark-mode');
      
      // Save preference
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      
      // Update icon
      themeToggle.innerHTML = isDark 
        ? '<span class="material-icons">brightness_7</span>' 
        : '<span class="material-icons">brightness_4</span>';
    });
    
    glassToggle.addEventListener('click', () => {
      body.classList.toggle('glass-effect');
      const hasGlassEffect = body.classList.contains('glass-effect');
      
      // Save preference
      localStorage.setItem('glassEffect', hasGlassEffect ? 'true' : 'false');
      
      // Update icon
      glassToggle.innerHTML = hasGlassEffect 
        ? '<span class="material-icons">blur_off</span>' 
        : '<span class="material-icons">blur_on</span>';
    });

    // Sidebar toggle
    sidebarToggle.addEventListener('click', () => {
      sidebar.classList.toggle('collapsed');
      localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
    });

    // Tab Navigation
    const menuItems = document.querySelectorAll('.menu-item');
    const tabContents = document.querySelectorAll('.tab-content');
    const navItems = document.querySelectorAll('.nav-item');
    
    function setActiveTab(tabId) {
      // Update menu items
      menuItems.forEach(item => {
        item.classList.toggle('active', item.dataset.tab === tabId);
      });
      
      // Update tab contents
      tabContents.forEach(content => {
        content.classList.toggle('active', content.id === `${tabId}-tab`);
      });
      
      // Update bottom nav items
      navItems.forEach(item => {
        item.classList.toggle('active', item.dataset.tab === tabId);
      });
      
      // Store active tab
      localStorage.setItem('activeTab', tabId);
      
      // Load data if needed
      if (tabId === 'analytics') {
        loadAnalyticsData();
      } else if (tabId === 'sessions') {
        loadSessionsTable();
      }
    }
    
    // Add click event to menu items
    menuItems.forEach(item => {
      item.addEventListener('click', () => {
        setActiveTab(item.dataset.tab);
      });
    });
    
    // Add click event to bottom nav items
    navItems.forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        setActiveTab(item.dataset.tab);
      });
    });
    
    // Check for saved active tab
    const savedActiveTab = localStorage.getItem('activeTab') || 'dashboard';
    setActiveTab(savedActiveTab);

    // Global variables
    let allSessions = [];
    let filteredSessions = [];
    let autoRefreshInterval;
    let currentPage = 1;
    const sessionsPerPage = 10;
    let selectedSessions = new Set();

    // Initialize the dashboard
    document.addEventListener('DOMContentLoaded', function() {
      loadSessionData();
      setupEventListeners();
      
      // Set up auto-refresh
      startAutoRefresh();
      
      // Set up keyboard shortcuts
      setupKeyboardShortcuts();
      
      // Update last updated time
      updateLastUpdatedTime();
    });

    // Update last updated time
    function updateLastUpdatedTime() {
      const now = new Date();
      const timeString = now.toLocaleTimeString();
      document.getElementById('lastUpdatedTime').textContent = `Last updated: ${timeString}`;
    }

    // Load session data from the server
    async function loadSessionData() {
      try {
        const response = await fetch('/logs');
        if (!response.ok) {
          throw new Error('Failed to fetch session data');
        }
        
        const sessions = await response.json();
        allSessions = sessions;
        filteredSessions = [...sessions];
        
        updateStats(sessions);
        updateCharts(sessions);
        renderSessionCards(sessions);
        
        // If on analytics tab, load analytics data
        if (document.querySelector('.tab-content.active').id === 'analytics-tab') {
          loadAnalyticsData();
        }
        
        // If on sessions tab, load sessions table
        if (document.querySelector('.tab-content.active').id === 'sessions-tab') {
          loadSessionsTable();
        }
        
        // Update last updated time
        updateLastUpdatedTime();
        
        // Cache the data
        localStorage.setItem('cachedSessions', JSON.stringify(sessions));
        localStorage.setItem('lastUpdated', new Date().getTime());
      } catch (error) {
        console.error('Error loading session data:', error);
        
        // Try to load cached data if available
        const cachedSessions = localStorage.getItem('cachedSessions');
        if (cachedSessions) {
          allSessions = JSON.parse(cachedSessions);
          filteredSessions = [...allSessions];
          updateStats(allSessions);
          updateCharts(allSessions);
          renderSessionCards(allSessions);
          
          Swal.fire({
            icon: 'warning',
            title: 'Using Cached Data',
            text: 'Failed to fetch new data. Displaying cached sessions.',
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Failed to load session data. Please try again later.',
          });
        }
      }
    }

    // Update stats cards
    function updateStats(sessions) {
      const statsGrid = document.getElementById('statsGrid');
      
      // Calculate stats
      const totalSessions = sessions.length;
      const avgTrustScore = sessions.reduce((sum, session) => sum + (session.content.trust_score || 0), 0) / totalSessions;
      const threatSessions = sessions.filter(s => (s.content.trust_score || 100) < 70).length;
      
      // Calculate average tap speed
      let totalTapDuration = 0;
      let totalTaps = 0;
      sessions.forEach(session => {
        if (session.content.tap_durations_ms) {
          totalTapDuration += session.content.tap_durations_ms.reduce((sum, duration) => sum + duration, 0);
          totalTaps += session.content.tap_durations_ms.length;
        }
      });
      const avgTapSpeed = totalTaps > 0 ? (totalTapDuration / totalTaps).toFixed(0) : 0;
      
      // Get location from latest session
      let recentLocation = 'Unknown';
      if (sessions.length > 0) {
        const latestSession = sessions[0];
        if (latestSession.content.location) {
          recentLocation = `${latestSession.content.location.latitude.toFixed(4)}, ${latestSession.content.location.longitude.toFixed(4)}`;
        }
      }
      
      // Create stats HTML
      statsGrid.innerHTML = `
        <div class="stat-card">
          <div class="stat-header">
            <div>
              <div class="stat-title">Total Sessions</div>
              <div class="stat-value" id="totalSessionsCounter">0</div>
            </div>
            <div class="stat-icon" style="background: var(--primary);">
              <span class="material-icons">insights</span>
            </div>
          </div>
          <div class="trend up">
            <span class="material-icons">trending_up</span>
            <span>${Math.floor(totalSessions * 0.12)} new today</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-header">
            <div>
              <div class="stat-title">Avg. Trust Score</div>
              <div class="stat-value" id="avgTrustScoreCounter">0%</div>
            </div>
            <div class="stat-icon" style="background: var(--success);">
              <span class="material-icons">verified</span>
            </div>
          </div>
          <div class="trend up">
            <span class="material-icons">trending_up</span>
            <span>${Math.floor(avgTrustScore * 0.03)}% from last week</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-header">
            <div>
              <div class="stat-title">Avg. Tap Speed</div>
              <div class="stat-value" id="avgTapSpeedCounter">0ms</div>
            </div>
            <div class="stat-icon" style="background: var(--warning);">
              <span class="material-icons">touch_app</span>
            </div>
          </div>
          <div class="trend down">
            <span class="material-icons">trending_down</span>
            <span>${Math.floor(avgTapSpeed * 0.05)}ms from last week</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-header">
            <div>
              <div class="stat-title">Recent Location</div>
              <div class="stat-value" id="recentLocationCounter">${recentLocation}</div>
            </div>
            <div class="stat-icon" style="background: var(--primary-light);">
              <span class="material-icons">location_on</span>
            </div>
          </div>
          <div class="trend">
            <span class="material-icons">public</span>
            <span>Last session</span>
          </div>
        </div>
      `;
      
      // Animate counters
      animateCounter('totalSessionsCounter', totalSessions, 0);
      animateCounter('avgTrustScoreCounter', Math.round(avgTrustScore), 0, '%');
      animateCounter('avgTapSpeedCounter', avgTapSpeed, 0, 'ms');
    }

    // Animate counter
    function animateCounter(elementId, target, current, suffix = '') {
      const element = document.getElementById(elementId);
      const increment = target / 50; // Adjust speed of animation
      
      const timer = setInterval(() => {
        current += increment;
        if (current >= target) {
          clearInterval(timer);
          current = target;
        }
        element.textContent = Math.round(current) + suffix;
      }, 20);
    }

    // Update charts
    let threatChartInstance;
    let sessionChartInstance;

    function updateCharts(sessions) {
      // Session Activity Chart - Group by day
      const sessionCountsByDay = {};
      const threatCountsByDay = {};
      
      // Initialize last 7 days
      const days = [];
      const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      for (let i = 6; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(today.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        days.push(dayNames[date.getDay()]);
        sessionCountsByDay[dateStr] = 0;
        threatCountsByDay[dateStr] = 0;
      }
      
      // Count sessions and threats by day
      sessions.forEach(session => {
        const sessionDate = new Date(session.content.session.start).toISOString().split('T')[0];
        if (sessionCountsByDay.hasOwnProperty(sessionDate)) {
          sessionCountsByDay[sessionDate]++;
          if ((session.content.trust_score || 100) < 70) {
            threatCountsByDay[sessionDate]++;
          }
        }
      });
      
      // Prepare data for chart
      const safeCounts = days.map((_, i) => {
        const date = new Date(today);
        date.setDate(today.getDate() - (6 - i));
        const dateStr = date.toISOString().split('T')[0];
        return sessionCountsByDay[dateStr] - threatCountsByDay[dateStr];
      });
      
      const threatCounts = days.map((_, i) => {
        const date = new Date(today);
        date.setDate(today.getDate() - (6 - i));
        const dateStr = date.toISOString().split('T')[0];
        return threatCountsByDay[dateStr];
      });
      
      const sessionChartOptions = {
        series: [{
          name: 'Safe Sessions',
          data: safeCounts
        }, {
          name: 'Threat Sessions',
          data: threatCounts
        }],
        chart: {
          height: 300,
          type: 'area',
          toolbar: {
            show: false
          },
          animations: {
            enabled: true,
            easing: 'easeinout',
            speed: 800
          }
        },
        colors: ['#4cc9f0', '#ef233c'],
        dataLabels: {
          enabled: false
        },
        stroke: {
          curve: 'smooth',
          width: 2
        },
        fill: {
          type: 'gradient',
          gradient: {
            shadeIntensity: 1,
            opacityFrom: 0.7,
            opacityTo: 0.3,
            stops: [0, 90, 100]
          }
        },
        xaxis: {
          categories: days
        },
        tooltip: {
          shared: true,
          intersect: false
        },
        legend: {
          position: 'top'
        }
      };
      
      if (sessionChartInstance) sessionChartInstance.destroy();
      document.querySelector("#sessionChart").innerHTML = '';
      sessionChartInstance = new ApexCharts(document.querySelector("#sessionChart"), sessionChartOptions);
      sessionChartInstance.render();
      
      // Threat Classification Chart
      const safeCount = sessions.filter(s => (s.content.trust_score || 100) >= 85).length;
      const suspiciousCount = sessions.filter(s => (s.content.trust_score || 100) >= 70 && (s.content.trust_score || 100) < 85).length;
      const threatCount = sessions.filter(s => (s.content.trust_score || 100) < 70).length;
      
      const threatChartOptions = {
        series: [safeCount, suspiciousCount, threatCount],
        chart: {
          type: 'donut',
          height: 300
        },
        colors: ['#4cc9f0', '#f8961e', '#ef233c'],
        labels: ['Safe', 'Suspicious', 'Threat'],
        responsive: [{
          breakpoint: 480,
          options: {
            chart: {
              width: 200
            },
            legend: {
              position: 'bottom'
            }
          }
        }],
        plotOptions: {
          pie: {
            donut: {
              size: '70%'
            }
          }
        },
        dataLabels: {
          enabled: false
        },
        legend: {
          position: 'right'
        },
        tooltip: {
          y: {
            formatter: function(value) {
              const total = safeCount + suspiciousCount + threatCount;
              const percentage = Math.round((value / total) * 100);
              return `${value} sessions (${percentage}%)`;
            }
          }
        }
      };
      
      if (threatChartInstance) threatChartInstance.destroy();
      document.querySelector("#threatChart").innerHTML = '';
      threatChartInstance = new ApexCharts(document.querySelector("#threatChart"), threatChartOptions);
      threatChartInstance.render();
    }

    // Load analytics data
    function loadAnalyticsData() {
      // Sessions per Device Manufacturer
      const manufacturerCounts = {};
      allSessions.forEach(session => {
        const manufacturer = session.content.device?.manufacturer || 'Unknown';
        manufacturerCounts[manufacturer] = (manufacturerCounts[manufacturer] || 0) + 1;
      });
      
      const manufacturerChartOptions = {
        series: [{
          name: 'Sessions',
          data: Object.entries(manufacturerCounts).map(([manufacturer, count]) => count)
        }],
        chart: {
          type: 'bar',
          height: 300,
          toolbar: {
            show: false
          }
        },
        plotOptions: {
          bar: {
            borderRadius: 4,
            horizontal: false,
          }
        },
        dataLabels: {
          enabled: false
        },
        xaxis: {
          categories: Object.keys(manufacturerCounts).map(m => m.charAt(0).toUpperCase() + m.slice(1))
        },
        colors: ['#4361ee'],
        tooltip: {
          y: {
            formatter: function(value) {
              return `${value} sessions`;
            }
          }
        }
      };
      
      const manufacturerChart = new ApexCharts(document.querySelector("#manufacturerChart"), manufacturerChartOptions);
      manufacturerChart.render();
      
      // Trust Score Distribution
      const trustScoreBins = Array(10).fill(0);
      allSessions.forEach(session => {
        const score = session.content.trust_score || 100;
        const bin = Math.floor(score / 10);
        trustScoreBins[bin === 10 ? 9 : bin]++;
      });
      
      const trustScoreChartOptions = {
        series: [{
          name: 'Sessions',
          data: trustScoreBins
        }],
        chart: {
          type: 'bar',
          height: 300,
          toolbar: {
            show: false
          }
        },
        plotOptions: {
          bar: {
            borderRadius: 4,
            horizontal: true,
          }
        },
        dataLabels: {
          enabled: false
        },
        xaxis: {
          categories: ['0-10', '10-20', '20-30', '30-40', '40-50', '50-60', '60-70', '70-80', '80-90', '90-100']
        },
        colors: ['#4895ef'],
        tooltip: {
          y: {
            formatter: function(value) {
              return `${value} sessions`;
            }
          }
        }
      };
      
      const trustScoreChart = new ApexCharts(document.querySelector("#trustScoreChart"), trustScoreChartOptions);
      trustScoreChart.render();
      
      // Screen Recording Detection
      const recordingCount = allSessions.filter(s => s.content.screen_recording_detected).length;
      const noRecordingCount = allSessions.length - recordingCount;
      
      const recordingChartOptions = {
        series: [recordingCount, noRecordingCount],
        chart: {
          type: 'pie',
          height: 300
        },
        labels: ['Recording Detected', 'No Recording'],
        colors: ['#f72585', '#4cc9f0'],
        responsive: [{
          breakpoint: 480,
          options: {
            chart: {
              width: 200
            },
            legend: {
              position: 'bottom'
            }
          }
        }],
        dataLabels: {
          enabled: false
        },
        legend: {
          position: 'right'
        }
      };
      
      const recordingChart = new ApexCharts(document.querySelector("#recordingChart"), recordingChartOptions);
      recordingChart.render();
      
      // Trust Score Over Time
      const last14Days = Array(14).fill().map((_, i) => {
        const date = new Date();
        date.setDate(date.getDate() - (13 - i));
        return date;
      });
      
      const avgTrustScores = last14Days.map(date => {
        const daySessions = allSessions.filter(s => {
          const sessionDate = new Date(s.content.session.start);
          return sessionDate.toDateString() === date.toDateString();
        });
        
        if (daySessions.length === 0) return 0;
        return daySessions.reduce((sum, s) => sum + (s.content.trust_score || 100), 0) / daySessions.length;
      });
      
      const trustScoreOverTimeOptions = {
        series: [{
          name: 'Average Trust Score',
          data: avgTrustScores
        }],
        chart: {
          height: 300,
          type: 'line',
          zoom: {
            enabled: false
          },
          toolbar: {
            show: false
          }
        },
        dataLabels: {
          enabled: false
        },
        stroke: {
          curve: 'smooth',
          width: 3
        },
        colors: ['#4361ee'],
        xaxis: {
          categories: last14Days.map(date => date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
        },
        yaxis: {
          min: 0,
          max: 100
        },
        tooltip: {
          y: {
            formatter: function(value) {
              return `${value.toFixed(1)}%`;
            }
          }
        }
      };
      
      const trustScoreOverTimeChart = new ApexCharts(document.querySelector("#trustScoreOverTimeChart"), trustScoreOverTimeOptions);
      trustScoreOverTimeChart.render();
      
      // Average Session Duration
      const durationBins = Array(6).fill(0).map((_, i) => {
        const min = i * 60;
        const max = (i + 1) * 60;
        return allSessions.filter(s => {
          const duration = s.content.session.duration_seconds;
          return duration >= min && duration < max;
        }).length;
      });
      
      const durationChartOptions = {
        series: [{
          name: 'Sessions',
          data: durationBins
        }],
        chart: {
          type: 'bar',
          height: 300,
          toolbar: {
            show: false
          }
        },
        plotOptions: {
          bar: {
            borderRadius: 4,
            horizontal: false,
          }
        },
        dataLabels: {
          enabled: false
        },
        xaxis: {
          categories: ['0-1 min', '1-2 min', '2-3 min', '3-4 min', '4-5 min', '5+ min']
        },
        colors: ['#3a0ca3'],
        tooltip: {
          y: {
            formatter: function(value) {
              return `${value} sessions`;
            }
          }
        }
      };
      
      const durationChart = new ApexCharts(document.querySelector("#durationChart"), durationChartOptions);
      durationChart.render();
      
      // Screens per Session
      const screensBins = Array(10).fill(0);
      allSessions.forEach(session => {
        const screens = session.content.screens_visited?.length || 0;
        const bin = Math.min(screens, 9);
        screensBins[bin]++;
      });
      
      const screensChartOptions = {
        series: [{
          name: 'Sessions',
          data: screensBins
        }],
        chart: {
          type: 'bar',
          height: 300,
          toolbar: {
            show: false
          }
        },
        plotOptions: {
          bar: {
            borderRadius: 4,
            horizontal: false,
          }
        },
        dataLabels: {
          enabled: false
        },
        xaxis: {
          categories: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10+']
        },
        colors: ['#f8961e'],
        tooltip: {
          y: {
            formatter: function(value) {
              return `${value} sessions`;
            }
          }
        }
      };
      
      const screensChart = new ApexCharts(document.querySelector("#screensChart"), screensChartOptions);
      screensChart.render();
    }

    // Load sessions table
    function loadSessionsTable(filtered = false) {
      const sessionsToDisplay = filtered ? filteredSessions : allSessions;
      const startIndex = (currentPage - 1) * sessionsPerPage;
      const endIndex = Math.min(startIndex + sessionsPerPage, sessionsToDisplay.length);
      const paginatedSessions = sessionsToDisplay.slice(startIndex, endIndex);
      
      const tableBody = document.getElementById('sessionsTableBody');
      tableBody.innerHTML = '';
      
      paginatedSessions.forEach(session => {
        const sessionId = session.content.session_id || session.filename;
        const trustScore = session.content.trust_score || 100;
        let statusClass = 'safe';
        let statusText = 'Safe';
        let statusIcon = '🟢';
        
        if (trustScore < 70) {
          statusClass = 'threat';
          statusText = 'Threat';
          statusIcon = '🔴';
        } else if (trustScore < 85) {
          statusClass = 'suspicious';
          statusText = 'Suspicious';
          statusIcon = '🟡';
        }
        
        const startTime = new Date(session.content.session.start);
        const formattedDate = startTime.toLocaleDateString();
        const formattedTime = startTime.toLocaleTimeString();
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>
            <input type="checkbox" class="session-checkbox" data-id="${sessionId}" ${selectedSessions.has(sessionId) ? 'checked' : ''}>
          </td>
          <td>${sessionId}</td>
          <td>
            <div>${formattedDate}</div>
            <div style="font-size: 12px; color: var(--gray);">${formattedTime}</div>
          </td>
          <td>
            <div>${session.content.device?.manufacturer || 'Unknown'}</div>
            <div style="font-size: 12px; color: var(--gray);">${session.content.device?.model || 'Unknown'}</div>
          </td>
          <td>
            <div style="font-weight: 600; color: ${trustScore >= 85 ? 'var(--success)' : trustScore >= 70 ? 'var(--warning)' : 'var(--danger)'}">
              ${trustScore}%
            </div>
          </td>
          <td>
            <span class="session-status ${statusClass}">
              <span class="status-icon">${statusIcon}</span>
              ${statusText}
            </span>
          </td>
          <td>
            ${Math.floor(session.content.session.duration_seconds / 60)}m ${session.content.session.duration_seconds % 60}s
          </td>
          <td>
            <button class="btn btn-outline btn-sm view-session-btn" data-id="${sessionId}" style="padding: 4px 8px; font-size: 12px;">
              <span class="material-icons" style="font-size: 16px;">visibility</span>
              View
            </button>
          </td>
        `;
        
        tableBody.appendChild(row);
      });
      
      // Update counters
      document.getElementById('showingCount').textContent = `${startIndex + 1}-${endIndex}`;
      document.getElementById('totalCount').textContent = sessionsToDisplay.length;
      
      // Update pagination buttons
      document.getElementById('prevPageBtn').disabled = currentPage === 1;
      document.getElementById('nextPageBtn').disabled = endIndex >= sessionsToDisplay.length;
      
      // Show/hide delete selected button
      document.getElementById('deleteSelectedBtn').style.display = selectedSessions.size > 0 ? 'flex' : 'none';
      
      // Add event listeners to checkboxes and view buttons
      document.querySelectorAll('.session-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const sessionId = this.dataset.id;
          if (this.checked) {
            selectedSessions.add(sessionId);
          } else {
            selectedSessions.delete(sessionId);
          }
          document.getElementById('deleteSelectedBtn').style.display = selectedSessions.size > 0 ? 'flex' : 'none';
        });
      });
      
      document.querySelectorAll('.view-session-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const sessionId = this.dataset.id;
          const session = allSessions.find(s => (s.content.session_id || s.filename) === sessionId);
          if (session) {
            showSessionDetails(session);
          }
        });
      });
    }

    // Render session cards
    function renderSessionCards(sessions) {
      const container = document.getElementById('sessionCardsContainer');
      container.innerHTML = '';
      
      // Sort by most recent first
      const sortedSessions = [...sessions].sort((a, b) => new Date(b.content.session.start) - new Date(a.content.session.start));
      
      // Limit to 10 most recent sessions
      const recentSessions = sortedSessions.slice(0, 10);
      
      recentSessions.forEach((session, index) => {
        const sessionId = session.content.session_id || session.filename;
        const trustScore = session.content.trust_score || 100;
        let statusClass = 'safe';
        let statusText = 'Safe';
        let statusIcon = '🟢';
        
        if (trustScore < 70) {
          statusClass = 'threat';
          statusText = 'Threat';
          statusIcon = '🔴';
        } else if (trustScore < 85) {
          statusClass = 'suspicious';
          statusText = 'Suspicious';
          statusIcon = '🟡';
        }
        
        // Format start time
        const startTime = new Date(session.content.session.start);
        const formattedTime = startTime.toLocaleString();
        
        // Create activity path from screens visited
        let activityPath = '';
        if (session.content.screens_visited && session.content.screens_visited.length > 0) {
          activityPath = session.content.screens_visited
            .map(screen => screen.screen || 'Unknown Screen')
            .join(' → ');
        }
        
        // Create heatmap cells
        const heatmapCells = session.content.tap_durations_ms
          ? session.content.tap_durations_ms.map(duration => {
              let bgColor = '#4cc9f0';
              let opacity = 0.3;
              let trend = '';
              
              if (duration > 3000) {
                bgColor = '#f8961e';
                opacity = 0.6;
                trend = '<span class="heatmap-trend" style="color: #f8961e;">↑</span>';
              }
              if (duration > 6000) {
                bgColor = '#ef233c';
                opacity = 1.0;
                trend = '<span class="heatmap-trend" style="color: #ef233c;">↑↑</span>';
              }
              
              return `<div class="heatmap-cell" style="background: ${bgColor}; opacity: ${opacity};">${duration}ms${trend}</div>`;
            }).join('')
          : '';
        
        // Create timeline items
        const timelineItems = session.content.screens_visited
          ? session.content.screens_visited.map((screen, i) => {
              const screenName = screen.screen || `Screen ${i + 1}`;
              return `
                <div class="timeline-item">
                  <div class="timeline-time">${new Date(startTime.getTime() + Math.floor(Math.random() * session.content.session.duration_seconds * 1000)).toLocaleTimeString()}</div>
                  <div class="timeline-content">
                    <div class="timeline-screen">${screenName}</div>
                    <div class="timeline-events">
                      <div class="timeline-event">${Math.floor((session.content.tap_durations_ms?.length || 0) / (session.content.screens_visited?.length || 1)) || 0} taps</div>
                    </div>
                  </div>
                </div>
              `;
            }).join('')
          : '';
        
        // Calculate gauge offset
        const gaugeOffset = 314 * (1 - trustScore / 100);
        
        // Create session card
        const card = document.createElement('div');
        card.className = `session-card ${statusClass}`;
        card.style.animationDelay = `${index * 0.05}s`;
        card.dataset.id = sessionId;
        card.innerHTML = `
          <div class="session-header">
            <div class="session-title">
              ${sessionId}
              <span class="session-status ${statusClass}">
                <span class="status-icon">${statusIcon}</span>
                ${statusText}
              </span>
            </div>
            <div class="session-meta">
              <span class="material-icons">schedule</span>
              <span>${session.content.session.duration_seconds} seconds</span>
            </div>
          </div>
          <div class="session-body">
            <div>
              ${activityPath ? `
              <div class="activity-path">
                <h4>Activity Path</h4>
                <div class="path-items">
                  ${activityPath.split(' → ').map(screen => `<span class="path-item">${screen}</span>`).join('')}
                </div>
              </div>
              ` : ''}
              <div class="session-stats">
                <div class="session-stat">
                  <div class="session-stat-value">${session.content.screens_visited?.length || 0}</div>
                  <div class="session-stat-label">Screens</div>
                </div>
                <div class="session-stat">
                  <div class="session-stat-value">${session.content.tap_durations_ms?.length || 0}</div>
                  <div class="session-stat-label">Taps</div>
                </div>
                <div class="session-stat">
                  <div class="session-stat-value">${session.content.swipe_events?.length || 0}</div>
                  <div class="session-stat-label">Swipes</div>
                </div>
                <div class="session-stat">
                  <div class="session-stat-value">${session.content.screen_recording_detected ? 'Yes' : 'No'}</div>
                  <div class="session-stat-label">Recording</div>
                </div>
                <div class="session-stat">
                  <div class="session-stat-value">${session.content.device?.manufacturer || 'Unknown'}</div>
                  <div class="session-stat-label">Device</div>
                </div>
                <div class="session-stat">
                  <div class="session-stat-value">Android ${session.content.device?.android_version || 'Unknown'}</div>
                  <div class="session-stat-label">OS</div>
                </div>
              </div>
              <div>
                <h4>Tap Heatmap</h4>
                <div class="heatmap">
                  ${heatmapCells}
                </div>
              </div>
            </div>
            <div>
              <div style="text-align: center;">
                <div class="trust-gauge ${trustScore >= 90 ? 'high-trust' : ''}">
                  <svg width="100%" height="100%" viewBox="0 0 120 120">
                    <circle class="gauge-bg" cx="60" cy="60" r="50"></circle>
                    <circle class="gauge-fill" cx="60" cy="60" r="50" stroke-dasharray="314" stroke-dashoffset="${gaugeOffset}"></circle>
                  </svg>
                  <div class="gauge-text">${trustScore}%</div>
                </div>
                <div class="gauge-label">Trust Score</div>
              </div>
              <div class="timeline">
                ${timelineItems}
              </div>
            </div>
          </div>
        `;
        
        // Add click event to show details
        card.addEventListener('click', () => {
          showSessionDetails(session);
        });
        
        container.appendChild(card);
      });
    }

    // Show session details modal
    function showSessionDetails(session) {
      const modal = document.getElementById('sessionModal');
      const jsonViewer = document.getElementById('sessionJsonViewer');
      
      // Format JSON with syntax highlighting
      const formattedJson = JSON.stringify(session, null, 2)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, match => {
          let cls = 'number';
          if (/^"/.test(match)) {
            if (/:$/.test(match)) {
              cls = 'key';
            } else {
              cls = 'string';
            }
          } else if (/true|false/.test(match)) {
            cls = 'boolean';
          } else if (/null/.test(match)) {
            cls = 'null';
          }
          return `<span class="${cls}">${match}</span>`;
        });
      
      jsonViewer.innerHTML = formattedJson;
      modal.style.display = 'block';
      
      // Add style for syntax highlighting
      const style = document.createElement('style');
      style.textContent = `
        .json-viewer .string { color: #4cc9f0; }
        .json-viewer .number { color: #f8961e; }
        .json-viewer .boolean { color: #f72585; }
        .json-viewer .null { color: #ef233c; }
        .json-viewer .key { color: #4361ee; }
      `;
      jsonViewer.appendChild(style);
    }

    // Close modal
    function closeModal() {
      document.getElementById('sessionModal').style.display = 'none';
    }

    // Filter sessions
    function filterSessions() {
      const dateFrom = document.getElementById('dateFrom').value;
      const dateTo = document.getElementById('dateTo').value;
      const trustScoreThreshold = parseInt(document.getElementById('trustScoreRange').value);
      const manufacturer = document.getElementById('deviceManufacturer').value;
      const screenRecording = document.getElementById('screenRecording').value;
      
      filteredSessions = allSessions.filter(session => {
        // Filter by date range
        if (dateFrom || dateTo) {
          const sessionDate = new Date(session.content.session.start).toISOString().split('T')[0];
          if (dateFrom && sessionDate < dateFrom) return false;
          if (dateTo && sessionDate > dateTo) return false;
        }
        
        // Filter by trust score
        const trustScore = session.content.trust_score || 100;
        if (trustScore < trustScoreThreshold) return false;
        
        // Filter by manufacturer
        if (manufacturer && session.content.device?.manufacturer?.toLowerCase() !== manufacturer.toLowerCase()) {
          return false;
        }
        
        // Filter by screen recording
        if (screenRecording !== '') {
          const hasRecording = session.content.screen_recording_detected;
          if (screenRecording === 'true' && !hasRecording) return false;
          if (screenRecording === 'false' && hasRecording) return false;
        }
        
        return true;
      });
      
      renderSessionCards(filteredSessions);
      document.getElementById('advancedFilters').classList.remove('active');
    }

    // Filter sessions for table view
    function filterSessionsTable() {
      const dateFrom = document.getElementById('sessionsDateFrom').value;
      const dateTo = document.getElementById('sessionsDateTo').value;
      const trustScoreThreshold = parseInt(document.getElementById('sessionsTrustScoreRange').value);
      const status = document.getElementById('sessionsStatus').value;
      const manufacturer = document.getElementById('sessionsDeviceManufacturer').value;
      
      filteredSessions = allSessions.filter(session => {
        // Filter by date range
        if (dateFrom || dateTo) {
          const sessionDate = new Date(session.content.session.start).toISOString().split('T')[0];
          if (dateFrom && sessionDate < dateFrom) return false;
          if (dateTo && sessionDate > dateTo) return false;
        }
        
        // Filter by trust score
        const trustScore = session.content.trust_score || 100;
        if (trustScore < trustScoreThreshold) return false;
        
        // Filter by status
        if (status) {
          let sessionStatus;
          if (trustScore >= 85) sessionStatus = 'safe';
          else if (trustScore >= 70) sessionStatus = 'suspicious';
          else sessionStatus = 'threat';
          
          if (sessionStatus !== status) return false;
        }
        
        // Filter by manufacturer
        if (manufacturer && session.content.device?.manufacturer?.toLowerCase() !== manufacturer.toLowerCase()) {
          return false;
        }
        
        return true;
      });
      
      currentPage = 1;
      loadSessionsTable(true);
      document.getElementById('sessionsAdvancedFilters').classList.remove('active');
    }

    // Export session data
    function exportSessionData() {
      Swal.fire({
        title: 'Export Sessions',
        text: 'Would you like to export all sessions or just the filtered ones?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Filtered Sessions',
        cancelButtonText: 'All Sessions',
        showDenyButton: true,
        denyButtonText: 'Cancel'
      }).then((result) => {
        if (result.isConfirmed) {
          // Export filtered sessions
          const dataStr = JSON.stringify(filteredSessions, null, 2);
          downloadJson(dataStr, `phishsafe-filtered-sessions-${new Date().toISOString()}.json`);
        } else if (result.isDismissed) {
          // Export all sessions
          const dataStr = JSON.stringify(allSessions, null, 2);
          downloadJson(dataStr, `phishsafe-all-sessions-${new Date().toISOString()}.json`);
        }
      });
    }

    // Export sessions table data
    function exportSessionsTableData() {
      const sessionsToExport = filteredSessions.length > 0 ? filteredSessions : allSessions;
      
      Swal.fire({
        title: 'Export Sessions',
        text: `Preparing to export ${sessionsToExport.length} sessions. Continue?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Export',
        cancelButtonText: 'Cancel'
      }).then((result) => {
        if (result.isConfirmed) {
          const dataStr = JSON.stringify(sessionsToExport, null, 2);
          downloadJson(dataStr, `phishsafe-sessions-${new Date().toISOString()}.json`);
        }
      });
    }

    // Download JSON file
    function downloadJson(dataStr, filename) {
      const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', filename);
      linkElement.click();
    }

    // Delete selected sessions
    function deleteSelectedSessions() {
  Swal.fire({
    title: 'Delete Sessions',
    text: `Are you sure you want to delete ${selectedSessions.size} selected sessions? This action cannot be undone.`,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Delete',
    cancelButtonText: 'Cancel',
    confirmButtonColor: '#ef233c'
  }).then(async (result) => {
    if (result.isConfirmed) {
      try {
        // Get the filenames of selected sessions
        const filenamesToDelete = [];
        allSessions.forEach(session => {
          if (selectedSessions.has(session.filename)) {
            filenamesToDelete.push(session.filename);
          }
        });

        // Call the backend to delete the files
        const response = await fetch('/delete_logs', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ filenames: filenamesToDelete })
        });

        if (!response.ok) {
          throw new Error('Failed to delete sessions on server');
        }

        const result = await response.json();

        // Update the frontend only if backend deletion was successful
        if (result.status === 'success') {
          // Reload data from server to get fresh state
          await loadSessionData();
          
          // Clear selection
          selectedSessions.clear();
          
          // Show success message
          Swal.fire({
            title: 'Deleted!',
            text: `Successfully deleted ${result.deleted.length} sessions.`,
            icon: 'success'
          });
        } else {
          throw new Error(result.message || 'Unknown error occurred');
        }
      } catch (error) {
        console.error('Error deleting sessions:', error);
        Swal.fire({
          title: 'Error',
          text: 'Failed to delete sessions: ' + error.message,
          icon: 'error'
        });
      }
    }
  });
}

    // Set up event listeners
    function setupEventListeners() {
      // Search functionality with debounce
      let searchTimeout;
      document.getElementById('searchInput').addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          const searchTerm = e.target.value.toLowerCase();
          filteredSessions = allSessions.filter(session => 
            (session.content.session_id || session.filename).toLowerCase().includes(searchTerm) ||
            JSON.stringify(session).toLowerCase().includes(searchTerm)
          );
          renderSessionCards(filteredSessions);
        }, 300);
      });
      
      // Auto-refresh toggle
      document.getElementById('autoRefreshBtn').addEventListener('click', function() {
        this.classList.toggle('active');
        if (this.classList.contains('active')) {
          startAutoRefresh();
        } else {
          stopAutoRefresh();
        }
      });
      
      // Filter button
      document.getElementById('filterBtn').addEventListener('click', function() {
        document.getElementById('advancedFilters').classList.toggle('active');
      });
      
      // Sessions filter button
      document.getElementById('sessionsFilterBtn').addEventListener('click', function() {
        document.getElementById('sessionsAdvancedFilters').classList.toggle('active');
      });
      
      // Apply filters
      document.getElementById('applyFilters').addEventListener('click', filterSessions);
      document.getElementById('sessionsApplyFilters').addEventListener('click', filterSessionsTable);
      
      // Reset filters
      document.getElementById('resetFilters').addEventListener('click', function() {
        document.getElementById('dateFrom').value = '';
        document.getElementById('dateTo').value = '';
        document.getElementById('trustScoreRange').value = 70;
        document.getElementById('trustScoreValue').textContent = '70+';
        document.getElementById('deviceManufacturer').value = '';
        document.getElementById('screenRecording').value = '';
        
        filteredSessions = [...allSessions];
        renderSessionCards(filteredSessions);
        document.getElementById('advancedFilters').classList.remove('active');
      });
      
      document.getElementById('sessionsResetFilters').addEventListener('click', function() {
        document.getElementById('sessionsDateFrom').value = '';
        document.getElementById('sessionsDateTo').value = '';
        document.getElementById('sessionsTrustScoreRange').value = 70;
        document.getElementById('sessionsTrustScoreValue').textContent = '70+';
        document.getElementById('sessionsStatus').value = '';
        document.getElementById('sessionsDeviceManufacturer').value = '';
        
        filteredSessions = [...allSessions];
        currentPage = 1;
        loadSessionsTable();
        document.getElementById('sessionsAdvancedFilters').classList.remove('active');
      });
      
      // Trust score range input
      document.getElementById('trustScoreRange').addEventListener('input', function() {
        document.getElementById('trustScoreValue').textContent = `${this.value}+`;
      });
      
      document.getElementById('sessionsTrustScoreRange').addEventListener('input', function() {
        document.getElementById('sessionsTrustScoreValue').textContent = `${this.value}+`;
      });
      
      // Export buttons
      document.getElementById('exportBtn').addEventListener('click', exportSessionData);
      document.getElementById('sessionsExportBtn').addEventListener('click', exportSessionsTableData);
      
      // Modal close buttons
      document.getElementById('modalClose').addEventListener('click', closeModal);
      document.getElementById('closeModalBtn').addEventListener('click', closeModal);
      
      // Copy JSON button
      document.getElementById('copyJsonBtn').addEventListener('click', function() {
        const jsonViewer = document.getElementById('sessionJsonViewer');
        const textToCopy = jsonViewer.textContent;
        
        navigator.clipboard.writeText(textToCopy).then(() => {
          Swal.fire({
            title: 'Copied!',
            text: 'Session JSON has been copied to clipboard.',
            icon: 'success',
            timer: 2000
          });
        });
      });
      
      // Pagination buttons
      document.getElementById('prevPageBtn').addEventListener('click', function() {
        if (currentPage > 1) {
          currentPage--;
          loadSessionsTable(filteredSessions.length > 0);
        }
      });
      
      document.getElementById('nextPageBtn').addEventListener('click', function() {
        const totalPages = Math.ceil((filteredSessions.length > 0 ? filteredSessions : allSessions).length / sessionsPerPage);
        if (currentPage < totalPages) {
          currentPage++;
          loadSessionsTable(filteredSessions.length > 0);
        }
      });
      
      // Select all button
      document.getElementById('selectAllBtn').addEventListener('click', function() {
        const sessionsToSelect = filteredSessions.length > 0 ? filteredSessions : allSessions;
        const startIndex = (currentPage - 1) * sessionsPerPage;
        const endIndex = Math.min(startIndex + sessionsPerPage, sessionsToSelect.length);
        
        for (let i = startIndex; i < endIndex; i++) {
          selectedSessions.add(sessionsToSelect[i].content.session_id || sessionsToSelect[i].filename);
        }
        
        loadSessionsTable(filteredSessions.length > 0);
      });
      
      // Delete selected button
      document.getElementById('deleteSelectedBtn').addEventListener('click', deleteSelectedSessions);
    }

    // Set up keyboard shortcuts
    function setupKeyboardShortcuts() {
      document.addEventListener('keydown', (e) => {
        // Focus search bar when / is pressed
        if (e.key === '/' && !e.target.matches('input, textarea, select')) {
          e.preventDefault();
          document.getElementById('searchInput').focus();
        }
        
        // Toggle theme when T is pressed
        if (e.key.toLowerCase() === 't' && !e.target.matches('input, textarea, select')) {
          e.preventDefault();
          themeToggle.click();
        }
        
        // Toggle sidebar when S is pressed
        if (e.key.toLowerCase() === 's' && !e.target.matches('input, textarea, select')) {
          e.preventDefault();
          sidebarToggle.click();
        }
        
        // Close modal when Escape is pressed
        if (e.key === 'Escape' && document.getElementById('sessionModal').style.display === 'block') {
          closeModal();
        }
        
        // Show help when ? is pressed
        if (e.key === '?') {
          e.preventDefault();
          Swal.fire({
            title: 'Keyboard Shortcuts',
            html: `
              <div style="text-align: left;">
                <p><strong>/</strong> - Focus search bar</p>
                <p><strong>T</strong> - Toggle dark mode</p>
                <p><strong>S</strong> - Toggle sidebar</p>
                <p><strong>Esc</strong> - Close modal</p>
                <p><strong>?</strong> - Show this help</p>
              </div>
            `,
            icon: 'info'
          });
        }
      });
    }

    // Auto-refresh functions
    function startAutoRefresh() {
      stopAutoRefresh(); // Clear any existing interval
      autoRefreshInterval = setInterval(loadSessionData, 30000);
      document.getElementById('autoRefreshBtn').classList.add('pulse');
    }

    function stopAutoRefresh() {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
      }
      document.getElementById('autoRefreshBtn').classList.remove('pulse');
    }
  </script>
</body>
</html>